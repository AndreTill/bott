import { Plugin } from 'gramio';

function mediaGroup(timeout = 150) {
  const map = /* @__PURE__ */ new Map();
  return new Plugin("@gramio/media-group").on(
    [
      "message",
      "channel_post",
      "business_message",
      "edited_message",
      "edited_channel_post",
      "edited_business_message"
    ],
    (context, next) => {
      if (!context.mediaGroupId) return next();
      const key = `${context.chat.id}-${context.mediaGroupId}`;
      const mediaGroupData = map.get(key);
      if (!mediaGroupData) {
        map.set(key, {
          messages: [context],
          next,
          timeout: setTimeout(next, timeout)
        });
      } else {
        clearTimeout(mediaGroupData.timeout);
        if (mediaGroupData.messages.length === 9) {
          map.set(key, {
            messages: [...mediaGroupData.messages, context],
            next: mediaGroupData.next,
            timeout: mediaGroupData.timeout
          });
          return mediaGroupData.next();
        }
        map.set(key, {
          messages: [...mediaGroupData.messages, context],
          next: mediaGroupData.next,
          // or maybe use `.refresh` ...
          timeout: setTimeout(mediaGroupData.next, timeout)
        });
      }
    }
  ).derive(
    [
      "message",
      "channel_post",
      "business_message",
      "edited_message",
      "edited_channel_post",
      "edited_business_message"
    ],
    (context) => {
      if (!context.mediaGroupId) return {};
      const key = `${context.chat.id}-${context.mediaGroupId}`;
      const data = map.get(key);
      if (data) map.delete(key);
      return {
        /** An array of messages from this media group */
        mediaGroup: data?.messages
      };
    }
  );
}

export { mediaGroup };
